# 2025gsc_YudaiKato
2025年ゼミ論

## Theme
音楽視聴履歴と移動ログを組み合わせた「音楽散歩地図」アプリの作成

## Introduction
音楽は人の気分や記憶と深い結びつきを持ち、移動中に聴いた音楽は場所の記憶と強く関連すると考えられる。そのため、日常の音楽聴取は、移動や場所、気分などの文脈と結びつきやすく、振り返りの手がかりになり得る。一方、一般的な再生履歴は時系列リストとして提示されることが多く、「どこで」「どんな気分で」聴いたかといった文脈は残りにくい。そこで本研究ではSpotify APIなどを用いて音楽の視聴履歴を取得し、位置情報と組み合わせて「音楽散歩地図」を生成する。これにより、音楽体験を空間的に可視化し、新しい体験価値や研究的知見を得ることを目的とする。さらに得られたデータを分析することで、時間帯や移動手段、天候や気分と音楽選択の関係を明らかにし、都市研究や観光への応用を目指す。また、ゼミ論での最終着地点としてはSpotifyの再生履歴を基盤として、再生単位で気分（mood）と天気を記録し、聴取体験を地図上で可視化して振り返ることを支援するWebアプリケーション（音楽散歩地図）のプロトタイプを開発することする。

## Method
### システム概要
プロトタイプは、
Spotify APIから再生履歴を取得し表示する機能
再生単位でユーザーが気分（mood）を登録する機能
聴取履歴を地図上にピンとして可視化する機能
から構成される。 フロントエンドは Next.js（App Router）で実装し、サーバ側のAPIルートでSpotify APIとの通信やデータアクセスを集約することで、クライアントからの外部サービス依存を最小化した。データベースには Supabase（PostgreSQL）を用い、聴取履歴（listens）と付随情報（mood、位置、時刻、天気）を保存する。地図表示には MapLibreを用い、聴取履歴をピンとして可視化する。

### Spotifyログイン
ユーザーが /api/spotify/login にアクセスするとPKCEが生成され、Spotifyの認可画面へリダイレクトされる。認可後、/api/spotify/callback でアクセストークンとリフレッシュトークンを取得し、Cookieに保存する。

### 楽曲情報取得
page.tsx で /api/spotify/currently-playing を15秒間隔でポーリングし、新しい再生が検知されると保存候補を作成する。続いてクライアント側で navigator.geolocation から緯度・経度を取得し、サーバ側 route.ts が OpenWeatherMap を呼び出して天気情報を取得する。

### DB保存（Supabase）
保存フローで得た情報をSupabaseに記録する。具体的には、tracks テーブルに spotify_track_id をキーとして楽曲情報を upsert し、listens テーブルには位置情報・再生時刻・mood・天気などを保存する。各再生を識別するため、取得した再生状況と取得時刻を同一再生ログを識別するためのキー情報として用いる。

### 保存後の地図描画フロー
保存が完了すると、クライアントは /api/listens から最新の聴取ログを取得し、Map表示に反映する。取得した listens には lat/lon や mood を含むため、クライアント側でmoodフィルタの状態に応じて表示対象を絞り込み、MapLibre上でマーカーを生成する。マーカーはmoodに応じた色分けを行い、クリック時には曲情報・再生時刻・天気等を含むポップアップを表示する。初回描画時には全マーカーが収まるよう fitBounds で表示範囲を調整し、サイドリストから選択した場合は対応マーカーへズームして強調表示する。



## Result
本研究では、Spotify再生履歴を基盤として、再生単位で位置情報（lat/lon）・天気・気分（mood）を記録し、地図上に可視化して振り返るWebアプリケーション（音楽散歩地図）のプロトタイプを実装した。SpotifyログインではPKCEフローにより認可を行い、/api/spotify/callback でアクセストークンおよびリフレッシュトークンを取得し、以後のSpotify API呼び出しに利用できる状態を確認した。楽曲情報取得では、/api/spotify/currently-playing を15秒間隔でポーリングすることで再生中トラックを検知し、新しい再生が検知された場合に保存候補を生成できることを確認した。

保存フローでは、クライアント側でGeolocationから緯度・経度を取得し、サーバ側でOpenWeatherMapを呼び出して天気情報を取得した上で、Supabaseへ聴取ログを保存できることを確認した。保存時には、tracksテーブルに spotify_track_id をキーとして楽曲情報を upsert し、listensテーブルには位置情報・再生時刻・mood・天気を含む再生単位ログを記録する構成を動作させた。さらに、各再生を識別するために、取得した再生状況と取得時刻を同一再生ログを識別するためのキー情報として用い、ポーリングに伴う重複保存の抑止を図る設計を適用した。

表示面では、/api/listens の最新データ取得により保存済みの聴取ログ一覧を反映し、moodフィルタに応じて表示対象を切り替えた上で、MapLibre上にマーカーを生成できることを確認した。マーカークリックにより曲情報・再生時刻・天気等の付随情報を参照でき、初回描画時には fitBounds により全マーカーが収まる表示範囲へ自動調整される。加えて、サイドリストから選択した際には該当マーカーへズームして強調表示できる状態となった。
## Discusstion
本研究のプロトタイプは、Spotify再生履歴に対して位置情報・天気・気分という文脈情報を付与し、地図上で可視化することで、時系列リストとしての再生履歴では残りにくい「どこで」「どんな状況で」聴いたかという振り返りを支援する基盤を提示した。特に、再生単位での記録を行い、地図上のマーカーとして分布を把握できる構成は、聴取体験を空間的に捉える新しい視点を提供し得る。さらに、moodや天気といった付随情報が記録されることにより、将来的には時間帯・天候・気分と音楽選択の関係を探索的に分析する枠組みに接続できる。


---


